import json

from requests_html import HTMLSession

DEFAULT_USER_AGENT = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'

def check_exploit(email: str) -> bool:
    session = HTMLSession()

    response = session.get('https://login.live.com/login.srf?', headers={
        'User-Agent': DEFAULT_USER_AGENT
    })

    data = response.text

    flow_token = data.split('id="i0327" value="')[1].split('"')[0]
    uaid = data.split('https://login.live.com/Me.htm?v=3&uaid=')[1].split('\'')[0]
    redirect_url = data.split('b9:\'')[1].split('\'')[0]

    response = session.post(redirect_url, data=json.dumps({
        'username': email,
        'checkPhones': False,
        'federationFlags': 3,
        'flowToken': flow_token,
        'forceotclogin': False,
        'isCookieBannerShown': False,
        'isExternalFederationDisallowed': False,
        'isFidoSupported': True,
        'isOtherIdpSupported': False,
        'isRemoteNGCSupported': True,
        'isSignup': False,
        'otclogindisallowed': False,
        'uaid': uaid
    }), headers={
        'Accept': 'application/json',
        'Client-Request-Id': uaid,
        'Content-Type': 'application/json; charset=UTF-8',
        'Origin': 'https://login.live.com',
        'Referer': 'https://login.live.com/login.srf?',
        'User-Agent': DEFAULT_USER_AGENT
    })

    data = response.json()

    return 'Credentials' in data and data['Credentials']['HasFido'] == 1
